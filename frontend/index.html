<!doctype html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <!-- Using Tailwind CSS via inline style - Production ready -->
    <style>
        /* Tailwind CSS Core */
        *,
        ::before,
        ::after {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb;
        }
        
        /* Base styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f9fafb;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }
        
        /* Utility classes */
        .h-full { height: 100%; }
        .w-full { width: 100%; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .flex { display: flex; }
        .hidden { display: none; }
        .block { display: block; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-end { justify-content: flex-end; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1 1 0%; }
        .flex-wrap { flex-wrap: wrap; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .space-x-3 > * + * { margin-left: 0.75rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-x-hidden { overflow-x: hidden; }
        
        /* Text styles */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-base { font-size: 1rem; line-height: 1.5rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        
        /* Font weights */
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        /* Colors */
        .text-gray-50 { color: #f9fafb; }
        .text-gray-100 { color: #f3f4f6; }
        .text-gray-200 { color: #e5e7eb; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-600 { color: #4b5563; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-gray-900 { color: #111827; }
        .text-green-50 { color: #f0fdf4; }
        .text-green-100 { color: #dcfce7; }
        .text-green-500 { color: #10b981; }
        .text-green-600 { color: #059669; }
        .text-green-700 { color: #047857; }
        .text-green-800 { color: #065f46; }
        .text-blue-50 { color: #eff6ff; }
        .text-blue-100 { color: #dbeafe; }
        .text-blue-500 { color: #3b82f6; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-800 { color: #1e40af; }
        .text-red-50 { color: #fef2f2; }
        .text-red-100 { color: #fee2e2; }
        .text-red-500 { color: #ef4444; }
        .text-red-600 { color: #dc2626; }
        .text-red-800 { color: #991b1b; }
        .text-white { color: #ffffff; }
        .text-black { color: #000000; }
        .text-purple-600 { color: #9333ea; }
        .text-pink-800 { color: #9d174d; }
        .text-yellow-800 { color: #92400e; }
        
        /* Backgrounds */
        .bg-white { background-color: #ffffff; }
        .bg-gray-50 { background-color: #f9fafb; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-green-50 { background-color: #f0fdf4; }
        .bg-green-100 { background-color: #dcfce7; }
        .bg-green-500 { background-color: #10b981; }
        .bg-green-600 { background-color: #059669; }
        .bg-blue-50 { background-color: #eff6ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-blue-600 { background-color: #2563eb; }
        .bg-red-50 { background-color: #fef2f2; }
        .bg-red-100 { background-color: #fee2e2; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-purple-50 { background-color: #faf5ff; }
        .bg-purple-100 { background-color: #f3e8ff; }
        .bg-purple-600 { background-color: #9333ea; }
        .bg-pink-100 { background-color: #fce7f3; }
        .bg-pink-800 { background-color: #9d174d; }
        .bg-yellow-100 { background-color: #fef3c7; }
        .bg-yellow-500 { background-color: #f59e0b; }
        .bg-yellow-600 { background-color: #d97706; }
        
        /* Borders */
        .border { border-width: 1px; }
        .border-0 { border-width: 0; }
        .border-t { border-top-width: 1px; }
        .border-b { border-bottom-width: 1px; }
        .border-l-4 { border-left-width: 4px; }
        .border-gray-100 { border-color: #f3f4f6; }
        .border-gray-200 { border-color: #e5e5e7; }
        .border-gray-300 { border-color: #d1d5db; }
        .border-green-200 { border-color: #bbf7d0; }
        .border-blue-200 { border-color: #bfdbfe; }
        .border-red-200 { border-color: #fecaca; }
        .border-yellow-200 { border-color: #fef3c7; }
        .rounded-md { border-radius: 0.375rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        /* Padding */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-12 { padding: 3rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .pt-6 { padding-top: 1.5rem; }
        .pb-6 { padding-bottom: 1.5rem; }
        
        /* Margin */
        .m-4 { margin: 1rem; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .my-4 { margin-top: 1rem; margin-bottom: 1rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mr-3 { margin-right: 0.75rem; }
        .ml-2 { margin-left: 0.5rem; }
        .ml-8 { margin-left: 2rem; }
        
        /* Width/Height */
        .w-5 { width: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .w-8 { width: 2rem; }
        .w-10 { width: 2.5rem; }
        .w-12 { width: 3rem; }
        .w-16 { width: 4rem; }
        .w-20 { width: 5rem; }
        .w-64 { width: 16rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-7xl { max-width: 80rem; }
        .min-w-full { min-width: 100%; }
        .h-5 { height: 1.25rem; }
        .h-6 { height: 1.5rem; }
        .h-8 { height: 2rem; }
        .h-10 { height: 2.5rem; }
        .h-12 { height: 3rem; }
        .h-16 { height: 4rem; }
        .h-20 { height: 5rem; }
        .min-h-screen { min-height: 100vh; }
        
        /* Grid */
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        
        /* Shadows */
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn-primary {
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .permission-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }
        
        .permission-admin {
            background: #dc2626;
            color: white;
        }
        
        .permission-doctor {
            background: #2563eb;
            color: white;
        }
        
        .permission-patient {
            background: #059669;
            color: white;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        
        /* Table */
        .divide-y > :not([hidden]) ~ :not([hidden]) {
            border-top-width: 1px;
            border-bottom-width: 0;
        }
        
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: #e5e7eb;
        }
        
        .tracking-wider {
            letter-spacing: 0.05em;
        }
        
        .uppercase {
            text-transform: uppercase;
        }
        
        .capitalize {
            text-transform: capitalize;
        }
        
        .whitespace-nowrap {
            white-space: nowrap;
        }
        
        /* Input */
        input, select, textarea {
            outline: none;
        }
        
        /* Gradient */
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
        }
        
        .from-green-50 {
            --tw-gradient-from: #f0fdf4;
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(240, 253, 244, 0));
        }
        
        .to-blue-50 {
            --tw-gradient-to: #eff6ff;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        /* Loading animation */
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <div id="app" class="h-full w-full"></div>
    
    <!-- Modals -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="patientModalTitle" class="text-xl font-bold">Add New Patient</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-700" data-modal="addPatientModal">
                    ‚úï
                </button>
            </div>
            <form id="addPatientForm">
                <input type="hidden" id="patientId" value="">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="patientName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                        <input type="number" id="patientAge" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="patientGender" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Medical Condition</label>
                        <input type="text" id="patientCondition" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Doctor</label>
                        <input type="text" id="patientDoctor" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Dr. Wilson">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="close-modal-btn px-4 py-2 border border-gray-300 rounded-md" data-modal="addPatientModal">Cancel</button>
                    <button id="patientSubmitBtn" type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Add Patient</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="addAppointmentModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="appointmentModalTitle" class="text-xl font-bold">Schedule Appointment</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-700" data-modal="addAppointmentModal">
                    ‚úï
                </button>
            </div>
            <form id="addAppointmentForm">
                <input type="hidden" id="appointmentId" value="">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                        <input type="text" id="appointmentPatientId" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="P001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Doctor ID</label>
                        <input type="text" id="appointmentDoctorId" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="D001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date & Time</label>
                        <input type="datetime-local" id="appointmentDateTime" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                        <input type="text" id="appointmentReason" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Follow-up consultation">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="close-modal-btn px-4 py-2 border border-gray-300 rounded-md" data-modal="addAppointmentModal">Cancel</button>
                    <button id="appointmentSubmitBtn" type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Schedule</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="userModalTitle" class="text-xl font-bold">Add User</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-700" data-modal="userModal">
                    ‚úï
                </button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId" value="">
                <input type="hidden" id="userMode" value="add">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                        <input type="text" id="userUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                        <input type="email" id="userEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="userFirstName" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="userLastName" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role *</label>
                        <select id="userRole" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="admin">Admin</option>
                            <option value="doctor">Doctor</option>
                            <option value="patient">Patient</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                        <select id="userStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div id="userPasswordRow">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password *</label>
                        <input type="password" id="userPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Enter a strong password">
                        <p class="text-xs text-gray-500 mt-1">Password is only required when creating a new user</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="close-modal-btn px-4 py-2 border border-gray-300 rounded-md" data-modal="userModal">Cancel</button>
                    <button id="userSubmitBtn" type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addDoctorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Add New Doctor</h3>
                <button class="close-modal-btn text-gray-500 hover:text-gray-700" data-modal="addDoctorModal">
                    ‚úï
                </button>
            </div>
            <form id="addDoctorForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="doctorName" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Specialty</label>
                        <input type="text" id="doctorSpecialty" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Cardiology">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="doctorEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                        <input type="text" id="doctorPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <input type="text" id="doctorDepartment" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="General Medicine">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
                        <input type="number" id="doctorExperience" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="close-modal-btn px-4 py-2 border border-gray-300 rounded-md" data-modal="addDoctorModal">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Add Doctor</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const API_BASE_URL = 'http://localhost:5000/api';
        const KEYCLOAK_CONFIG = {
            url: 'http://localhost:8080',
            realm: 'hospital-realm',
            clientId: 'hospital-frontend',
            redirectUri: 'http://localhost:3000'
        };

        // ==================== APP STATE ====================
        let appState = {
            currentUser: null,
            currentPage: 'login',
            currentRole: null,
            accessToken: null,
            refreshToken: null,
            currentUserProfile: null,
            data: {
                patients: [],
                doctors: [],
                appointments: [],
                medicalRecords: [],
                users: []
            }
        };

        // ==================== AUTH FUNCTIONS ====================
        function checkForCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (code) {
                handleKeycloakCallback(code);
                return true;
            }
            
            if (error) {
                showError('Login failed: ' + error);
                return true;
            }
            
            return false;
        }

        async function handleKeycloakCallback(code) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code,
                        redirect_uri: KEYCLOAK_CONFIG.redirectUri
                    })
                });

                if (!response.ok) {
                    throw new Error(`Token exchange failed: ${response.status}`);
                }

                const data = await response.json();
                
                // Store tokens
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                localStorage.setItem('user_info', JSON.stringify(data.user));
                
                appState.accessToken = data.access_token;
                appState.refreshToken = data.refresh_token;
                appState.currentUser = data.user;
                appState.currentRole = determineRole(data.user.roles || []);
                appState.currentPage = 'dashboard';
                
                // Remove code from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Fetch initial data
                await fetchInitialData();
                render();
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showError('Authentication failed. Please try again.');
            }
        }

        function init() {
            console.log('üöÄ Initializing app...');
            
            const isCallback = checkForCallback();
            
            if (!isCallback) {
                checkExistingSession();
            }
            
            render();
        }

        function checkExistingSession() {
            const token = localStorage.getItem('access_token');
            const user = localStorage.getItem('user_info');
            
            if (token && user) {
                appState.accessToken = token;
                appState.currentUser = JSON.parse(user);
                appState.currentRole = determineRole(appState.currentUser.roles || []);
                appState.currentPage = 'dashboard';
                
                fetchInitialData();
            }
        }

        function determineRole(roles) {
            if (roles.includes('admin')) return 'admin';
            if (roles.includes('doctor')) return 'doctor';
            if (roles.includes('patient')) return 'patient';
            return 'viewer';
        }

        async function fetchInitialData() {
            try {
                const headers = getHeaders();
                
                // Fetch patients
                await fetchPatients();
                
                // Fetch doctors
                await fetchDoctors();
                
                // Fetch appointments
                await fetchAppointments();
                
                // Fetch medical records (if authorized)
                if (appState.currentRole === 'doctor' || appState.currentRole === 'admin') {
                    await fetchMedicalRecords();
                }

                // Fetch users if admin
                if (appState.currentRole === 'admin') {
                    await fetchUsers();
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function fetchPatients() {
            try {
                const headers = getHeaders();
                const patientsRes = await fetch(`${API_BASE_URL}/patients`, { headers });
                if (patientsRes.ok) {
                    let patients = await patientsRes.json();
                    
                    // Filter for patient role
                    if (appState.currentRole === 'patient') {
                        const username = appState.currentUser?.username || '';
                        patients = patients.slice(0, 1).map(p => ({
                            ...p,
                            name: `${username} (Demo Patient)`,
                            condition: "Regular Checkup"
                        }));
                    }
                    
                    appState.data.patients = patients;
                }
            } catch (error) {
                console.error('Error fetching patients:', error);
            }
        }

        async function fetchDoctors() {
            try {
                const headers = getHeaders();
                const doctorsRes = await fetch(`${API_BASE_URL}/doctors`, { headers });
                if (doctorsRes.ok) {
                    appState.data.doctors = await doctorsRes.json();
                }
            } catch (error) {
                console.error('Error fetching doctors:', error);
            }
        }

        async function fetchAppointments() {
            try {
                const headers = getHeaders();
                const appointmentsRes = await fetch(`${API_BASE_URL}/appointments`, { headers });
                if (appointmentsRes.ok) {
                    let appointments = await appointmentsRes.json();
                    
                    // Filter for patient role
                    if (appState.currentRole === 'patient') {
                        const username = appState.currentUser?.username || '';
                        appointments = appointments.slice(0, 1).map(a => ({
                            ...a,
                            patient_id: "P001",
                            reason: "Regular Checkup"
                        }));
                    }
                    
                    appState.data.appointments = appointments;
                }
            } catch (error) {
                console.error('Error fetching appointments:', error);
            }
        }

        async function fetchMedicalRecords() {
            try {
                const headers = getHeaders();
                const recordsRes = await fetch(`${API_BASE_URL}/medical-records`, { headers });
                if (recordsRes.ok) {
                    appState.data.medicalRecords = await recordsRes.json();
                }
            } catch (error) {
                console.error('Error fetching medical records:', error);
            }
        }

        // ==================== USER MANAGEMENT API FUNCTIONS ====================
        async function fetchUsers() {
            try {
                const headers = getHeaders();
                const usersRes = await fetch(`${API_BASE_URL}/users`, { headers });
                
                if (usersRes.ok) {
                    const users = await usersRes.json();
                    console.log('üìã Users fetched:', users);
                    
                    // Format the users for display
                    const formattedUsers = users.map(user => ({
                        id: user.id || '',
                        username: user.username || '',
                        email: user.email || '',
                        firstName: user.firstName || '',
                        lastName: user.lastName || '',
                        role: user.role || 'patient',
                        status: user.status || 'active'
                    }));
                    
                    appState.data.users = formattedUsers;
                } else {
                    const errorText = await usersRes.text();
                    console.error('‚ùå Failed to fetch users:', usersRes.status, errorText);
                    showError(`Failed to fetch users: ${usersRes.status} ${usersRes.statusText}`);
                    
                    // Fallback to mock data for testing
                    console.log('‚ö†Ô∏è Using mock users for testing');
                    const mockUsers = [
                        {
                            id: '1',
                            username: 'admin1',
                            email: 'admin@hospital.com',
                            role: 'admin',
                            status: 'active',
                            firstName: 'Admin',
                            lastName: 'User'
                        },
                        {
                            id: '2',
                            username: 'doctor1',
                            email: 'doctor@hospital.com',
                            role: 'doctor',
                            status: 'active',
                            firstName: 'John',
                            lastName: 'Smith'
                        },
                        {
                            id: '3',
                            username: 'patient1',
                            email: 'patient@hospital.com',
                            role: 'patient',
                            status: 'active',
                            firstName: 'Jane',
                            lastName: 'Doe'
                        }
                    ];
                    appState.data.users = mockUsers;
                }
            } catch (error) {
                console.error('‚ùå Error fetching users:', error);
                showError('Error loading users. Check console for details.');
                appState.data.users = [];
            }
        }

        async function createUser(userData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        username: userData.username,
                        email: userData.email,
                        password: userData.password,
                        role: userData.role,
                        status: userData.status || 'active',
                        firstName: userData.firstName || '',
                        lastName: userData.lastName || ''
                    })
                });
                
                console.log('üì§ Create user response:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User created:', result);
                    showSuccess(result.message || 'User created successfully');
                    await fetchUsers();
                    return { success: true, userId: result.user_id || result.id };
                } else {
                    let errorMessage = `Failed to create user: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    }
                    console.error('‚ùå Create user error:', errorMessage);
                    showError(errorMessage);
                    return { success: false };
                }
            } catch (error) {
                console.error('‚ùå Network error creating user:', error);
                showError(`Network error: ${error.message}`);
                return { success: false };
            }
        }

        async function updateUser(userId, userData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({
                        username: userData.username,
                        email: userData.email,
                        role: userData.role,
                        status: userData.status,
                        firstName: userData.firstName || '',
                        lastName: userData.lastName || ''
                    })
                });
                
                console.log('üì§ Update user response:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User updated:', result);
                    showSuccess(result.message || 'User updated successfully');
                    await fetchUsers();
                    return true;
                } else {
                    let errorMessage = `Failed to update user: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    }
                    console.error('‚ùå Update user error:', errorMessage);
                    showError(errorMessage);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Network error updating user:', error);
                showError(`Network error: ${error.message}`);
                return false;
            }
        }

        async function deleteUserAPI(userId) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                console.log('üì§ Delete user response:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ User deleted:', result);
                    showSuccess(result.message || 'User deleted successfully');
                    await fetchUsers();
                    return true;
                } else {
                    let errorMessage = `Failed to delete user: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) errorMessage = errorText;
                    }
                    console.error('‚ùå Delete user error:', errorMessage);
                    showError(errorMessage);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Network error deleting user:', error);
                showError(`Network error: ${error.message}`);
                return false;
            }
        }

        function getHeaders() {
            return {
                'Authorization': `Bearer ${appState.accessToken}`,
                'Content-Type': 'application/json'
            };
        }

        function redirectToKeycloak() {
            const authUrl = `${KEYCLOAK_CONFIG.url}/realms/${KEYCLOAK_CONFIG.realm}/protocol/openid-connect/auth` +
                `?client_id=${KEYCLOAK_CONFIG.clientId}` +
                `&redirect_uri=${encodeURIComponent(KEYCLOAK_CONFIG.redirectUri)}` +
                `&response_type=code` +
                `&scope=openid profile email` +
                `&state=${Date.now()}`;
            
            window.location.href = authUrl;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_info');
            
            appState.currentUser = null;
            appState.currentRole = null;
            appState.accessToken = null;
            appState.refreshToken = null;
            appState.currentPage = 'login';
            appState.data = { patients: [], doctors: [], appointments: [], medicalRecords: [], users: [] };
            
            render();
        }

        // ==================== API CRUD FUNCTIONS ====================
        async function createPatient(patientData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(patientData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Patient created successfully');
                    await fetchPatients();
                    return { success: true, id: result.patient_id };
                } else {
                    const error = await response.json();
                    showError(`Failed to create patient: ${error.error || response.statusText}`);
                    return { success: false };
                }
            } catch (error) {
                showError(`Error creating patient: ${error.message}`);
                return { success: false };
            }
        }

        async function updatePatient(patientId, patientData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(patientData)
                });
                
                if (response.ok) {
                    showSuccess('Patient updated successfully');
                    await fetchPatients();
                    return true;
                } else {
                    const error = await response.json();
                    showError(`Failed to update patient: ${error.error || response.statusText}`);
                    return false;
                }
            } catch (error) {
                showError(`Error updating patient: ${error.message}`);
                return false;
            }
        }

        async function deletePatient(patientId) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/patients/${patientId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                if (response.ok) {
                    showSuccess('Patient deleted successfully');
                    await fetchPatients();
                    return true;
                } else {
                    const error = await response.json();
                    showError(`Failed to delete patient: ${error.error || response.statusText}`);
                    return false;
                }
            } catch (error) {
                showError(`Error deleting patient: ${error.message}`);
                return false;
            }
        }

        async function createAppointment(appointmentData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/appointments`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(appointmentData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Appointment scheduled successfully');
                    await fetchAppointments();
                    return { success: true, id: result.appointment_id };
                } else {
                    const error = await response.json();
                    showError(`Failed to create appointment: ${error.error || response.statusText}`);
                    return { success: false };
                }
            } catch (error) {
                showError(`Error creating appointment: ${error.message}`);
                return { success: false };
            }
        }

        async function updateAppointment(appointmentId, appointmentData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(appointmentData)
                });
                
                if (response.ok) {
                    showSuccess('Appointment updated successfully');
                    await fetchAppointments();
                    return true;
                } else {
                    const error = await response.json();
                    showError(`Failed to update appointment: ${error.error || response.statusText}`);
                    return false;
                }
            } catch (error) {
                showError(`Error updating appointment: ${error.message}`);
                return false;
            }
        }

        async function deleteAppointment(appointmentId) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                if (response.ok) {
                    showSuccess('Appointment deleted successfully');
                    await fetchAppointments();
                    return true;
                } else {
                    const error = await response.json();
                    showError(`Failed to delete appointment: ${error.error || response.statusText}`);
                    return false;
                }
            } catch (error) {
                showError(`Error deleting appointment: ${error.message}`);
                return false;
            }
        }

        async function createDoctor(doctorData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/doctors`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(doctorData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Doctor added successfully');
                    await fetchDoctors();
                    return { success: true, id: result.doctor_id };
                } else {
                    const error = await response.json();
                    showError(`Failed to create doctor: ${error.error || response.statusText}`);
                    return { success: false };
                }
            } catch (error) {
                showError(`Error creating doctor: ${error.message}`);
                return { success: false };
            }
        }

        async function updateDoctor(doctorId, doctorData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/doctors/${doctorId}`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(doctorData)
                });
                
                if (response.ok) {
                    showSuccess('Doctor updated successfully');
                    await fetchDoctors();
                    return true;
                } else {
                    const error = await response.json();
                    showError(`Failed to update doctor: ${error.error || response.statusText}`);
                    return false;
                }
            } catch (error) {
                showError(`Error updating doctor: ${error.message}`);
                return false;
            }
        }

        async function createMedicalRecord(recordData) {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/medical-records`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(recordData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Medical record created successfully');
                    await fetchMedicalRecords();
                    return { success: true, id: result.record_id };
                } else {
                    const error = await response.json();
                    showError(`Failed to create medical record: ${error.error || response.statusText}`);
                    return { success: false };
                }
            } catch (error) {
                showError(`Error creating medical record: ${error.message}`);
                return { success: false };
            }
        }

        // ==================== PROFILE MANAGEMENT FUNCTIONS ====================
        async function loadProfileData() {
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/profile`, { headers });
                
                if (response.ok) {
                    const profileData = await response.json();
                    
                    // Update profile display
                    const profileInfo = document.getElementById('profileInfo');
                    if (profileInfo) {
                        let roleSpecificInfo = '';
                        
                        if (profileData.patientInfo) {
                            roleSpecificInfo = `
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h3 class="font-semibold text-gray-900 mb-3">Patient Information</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600">Patient ID</p>
                                            <p class="font-medium">${profileData.patientInfo.patientId || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Medical Condition</p>
                                            <p class="font-medium">${profileData.patientInfo.condition || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Assigned Doctor</p>
                                            <p class="font-medium">${profileData.patientInfo.doctor || 'Unassigned'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Age/Gender</p>
                                            <p class="font-medium">${profileData.patientInfo.age || 'N/A'} / ${profileData.patientInfo.gender || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (profileData.doctorInfo) {
                            roleSpecificInfo = `
                                <div class="mt-6 pt-6 border-t border-gray-200">
                                    <h3 class="font-semibold text-gray-900 mb-3">Doctor Information</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <p class="text-sm text-gray-600">Doctor ID</p>
                                            <p class="font-medium">${profileData.doctorInfo.doctorId || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Specialty</p>
                                            <p class="font-medium">${profileData.doctorInfo.specialty || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Department</p>
                                            <p class="font-medium">${profileData.doctorInfo.department || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">Experience</p>
                                            <p class="font-medium">${profileData.doctorInfo.experience || '0'} years</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        profileInfo.innerHTML = `
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <p class="text-sm text-gray-600">Username</p>
                                    <p class="font-medium">${profileData.username || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Email</p>
                                    <p class="font-medium">${profileData.email || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">First Name</p>
                                    <p class="font-medium">${profileData.firstName || 'Not set'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Last Name</p>
                                    <p class="font-medium">${profileData.lastName || 'Not set'}</p>
                                </div>
                            </div>
                            ${roleSpecificInfo}
                        `;
                    }
                    
                    // Update account summary
                    const accountCreated = document.getElementById('accountCreated');
                    const emailVerified = document.getElementById('emailVerified');
                    const accountStatus = document.getElementById('accountStatus');
                    
                    if (accountCreated) {
                        accountCreated.textContent = profileData.created ? new Date(profileData.created).toLocaleDateString() : 'Unknown';
                    }
                    if (emailVerified) {
                        emailVerified.textContent = profileData.emailVerified ? 'Yes' : 'No';
                        if (emailVerified) {
                            emailVerified.className = profileData.emailVerified ? 'font-medium text-green-600' : 'font-medium text-yellow-600';
                        }
                    }
                    if (accountStatus) {
                        accountStatus.textContent = profileData.status === 'active' ? 'Active' : 'Inactive';
                        accountStatus.className = profileData.status === 'active' ? 'font-medium text-green-600' : 'font-medium text-red-600';
                    }
                    
                    // Store profile data for editing
                    appState.currentUserProfile = profileData;
                    
                } else {
                    showError('Failed to load profile data');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Error loading profile');
            }
        }

        function showEditProfileModal() {
            const profile = appState.currentUserProfile || {};
            
            // Create modal HTML
            const modalHTML = `
                <div id="editProfileModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Edit Profile</h3>
                            <button class="close-modal-btn text-gray-500 hover:text-gray-700" onclick="closeEditProfileModal()">
                                ‚úï
                            </button>
                        </div>
                        
                        <form id="editProfileForm" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                    <input type="text" id="editFirstName" value="${profile.firstName || ''}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                    <input type="text" id="editLastName" value="${profile.lastName || ''}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                <input type="email" id="editEmail" value="${profile.email || ''}" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            
                            ${profile.patientInfo ? `
                            <div class="pt-4 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-900 mb-3">Patient Information</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input type="text" id="editPatientName" value="${profile.patientInfo.name || ''}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                        <input type="number" id="editPatientAge" value="${profile.patientInfo.age || ''}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                        <select id="editPatientGender" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                            <option value="Male" ${profile.patientInfo.gender === 'Male' ? 'selected' : ''}>Male</option>
                                            <option value="Female" ${profile.patientInfo.gender === 'Female' ? 'selected' : ''}>Female</option>
                                            <option value="Other" ${profile.patientInfo.gender === 'Other' ? 'selected' : ''}>Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${profile.doctorInfo ? `
                            <div class="pt-4 border-t border-gray-200">
                                <h4 class="font-semibold text-gray-900 mb-3">Doctor Information</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                        <input type="text" id="editDoctorName" value="${profile.doctorInfo.name || ''}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Specialty</label>
                                        <input type="text" id="editDoctorSpecialty" value="${profile.doctorInfo.specialty || ''}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                                        <input type="text" id="editDoctorDepartment" value="${profile.doctorInfo.department || ''}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div class="flex justify-end space-x-3 pt-6">
                                <button type="button" onclick="closeEditProfileModal()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                                    Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Add modal to body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            // Add form submit handler
            document.getElementById('editProfileForm').onsubmit = handleEditProfileSubmit;
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                modal.remove();
            }
        }

        async function handleEditProfileSubmit(e) {
            e.preventDefault();
            
            const profile = appState.currentUserProfile || {};
            const updateData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value
            };
            
            // Add role-specific data
            if (profile.patientInfo) {
                updateData.patientInfo = {
                    name: document.getElementById('editPatientName').value,
                    age: document.getElementById('editPatientAge').value,
                    gender: document.getElementById('editPatientGender').value
                };
            } else if (profile.doctorInfo) {
                updateData.doctorInfo = {
                    name: document.getElementById('editDoctorName').value,
                    specialty: document.getElementById('editDoctorSpecialty').value,
                    department: document.getElementById('editDoctorDepartment').value
                };
            }
            
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    showSuccess('Profile updated successfully');
                    closeEditProfileModal();
                    await loadProfileData();
                    
                    // Update app state if email changed
                    if (updateData.email && appState.currentUser) {
                        appState.currentUser.email = updateData.email;
                    }
                } else {
                    const error = await response.json();
                    showError(`Failed to update profile: ${error.error || response.statusText}`);
                }
            } catch (error) {
                showError(`Error updating profile: ${error.message}`);
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('New password must be at least 6 characters long');
                return;
            }
            
            try {
                const headers = getHeaders();
                const response = await fetch(`${API_BASE_URL}/profile/password`, {
                    method: 'PUT',
                    headers: headers,
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                if (response.ok) {
                    showSuccess('Password changed successfully');
                    document.getElementById('changePasswordForm').reset();
                } else {
                    const error = await response.json();
                    showError(`Failed to change password: ${error.error || response.statusText}`);
                }
            } catch (error) {
                showError(`Error changing password: ${error.message}`);
            }
        }

        // ==================== UI HELPER FUNCTIONS ====================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            alert('Success: ' + message);
        }

        // ==================== PERMISSION CHECKS ====================
        function canCreate() {
            return ['admin', 'doctor'].includes(appState.currentRole);
        }

        function canEdit() {
            return ['admin', 'doctor'].includes(appState.currentRole);
        }

        function canDelete() {
            return appState.currentRole === 'admin';
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            if (appState.currentPage === 'login') {
                app.innerHTML = renderLoginPage();
            } else {
                app.innerHTML = renderDashboard();
            }
            
            attachEventHandlers();
        }

        function renderLoginPage() {
            return `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-blue-50">
                    <div class="max-w-md w-full mx-4">
                        <div class="bg-white p-8 rounded-2xl shadow-xl">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-green-500 flex items-center justify-center">
                                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-900 mb-2">MediCare Hospital</h1>
                                <h2 class="text-xl font-semibold text-gray-700 mb-2">Role-Based Access System</h2>
                                <p class="text-gray-600">Sign in with your assigned role</p>
                            </div>
                            
                            <button 
                                id="keycloakLoginBtn"
                                class="w-full py-3 rounded-lg font-semibold btn-primary flex items-center justify-center gap-2 bg-green-500 text-white hover:bg-green-600"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                                </svg>
                                Sign in with Keycloak
                            </button>
                            
                            <div class="mt-6 pt-6 border-t border-gray-200">
                                <p class="text-sm text-gray-600 text-center mb-3">
                                    <span class="font-semibold">Test Credentials:</span>
                                </p>
                                <div class="space-y-2 text-sm text-center">
                                    <div>üëë <span class="font-medium">Admin:</span> admin1 / pass123 (Full CRUD)</div>
                                    <div>üë®‚Äç‚öïÔ∏è <span class="font-medium">Doctor:</span> doctor1 / pass123 (Create, Read, Update)</div>
                                    <div>üë§ <span class="font-medium">Patient:</span> patient1 / pass123 (Read Only)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const username = appState.currentUser?.username || 'User';
            const email = appState.currentUser?.email || 'N/A';
            const role = appState.currentRole || 'viewer';
            
            return `
                <div class="h-full flex bg-gray-50">
                    <!-- Sidebar -->
                    <div class="w-64 h-full bg-white shadow-lg flex flex-col">
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="font-bold text-gray-900">MediCare Hospital</h2>
                                    <p class="text-sm text-gray-600">Role-Based System</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 p-4">
                            <p class="text-xs text-gray-500 uppercase font-semibold mb-2">Main Menu</p>
                            <div class="space-y-1">
                                <button data-page="dashboard" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'dashboard' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                                        </svg>
                                        Dashboard
                                    </div>
                                </button>
                                
                                <button data-page="patients" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'patients' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                        </svg>
                                        Patients
                                    </div>
                                    <span class="permission-badge ${role === 'admin' ? 'permission-admin' : role === 'doctor' ? 'permission-doctor' : 'permission-patient'}">
                                        ${role === 'admin' ? 'CRUD' : role === 'doctor' ? 'CRU' : 'R'}
                                    </span>
                                </button>
                                
                                <button data-page="doctors" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'doctors' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        Doctors
                                    </div>
                                    <span class="permission-badge ${role === 'admin' ? 'permission-admin' : 'permission-doctor'}">
                                        ${role === 'admin' ? 'CRU' : 'R'}
                                    </span>
                                </button>
                                
                                <button data-page="appointments" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'appointments' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        Appointments
                                    </div>
                                    <span class="permission-badge ${role === 'admin' ? 'permission-admin' : role === 'doctor' ? 'permission-doctor' : 'permission-patient'}">
                                        ${role === 'admin' ? 'CRUD' : role === 'doctor' ? 'CRU' : 'R'}
                                    </span>
                                </button>
                                
                                ${role === 'admin' || role === 'doctor' ? `
                                <button data-page="medical-records" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'medical-records' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Medical Records
                                    </div>
                                    <span class="permission-badge ${role === 'admin' ? 'permission-admin' : 'permission-doctor'}">
                                        ${role === 'admin' ? 'CR' : 'CR'}
                                    </span>
                                </button>
                                ` : ''}
                                
                                ${role === 'admin' ? `
                                <button data-page="users" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'users' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                        </svg>
                                        User Management
                                    </div>
                                    <span class="permission-badge permission-admin">Admin Only</span>
                                </button>
                                ` : ''}
                                
                                <!-- Profile Menu Item -->
                                <button data-page="profile" class="w-full text-left px-4 py-3 rounded-lg hover:bg-green-50 flex items-center justify-between text-gray-700 ${appState.currentPage === 'profile' ? 'bg-green-50 border-l-4 border-green-500' : ''}">
                                    <div class="flex items-center gap-3">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                        My Profile
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-gray-100">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-full ${role === 'admin' ? 'bg-red-500' : role === 'doctor' ? 'bg-blue-500' : 'bg-green-500'} flex items-center justify-center">
                                    <span class="text-white font-semibold">
                                        ${username.charAt(0).toUpperCase()}
                                    </span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">${username}</p>
                                    <p class="text-sm text-gray-600 capitalize">${role}</p>
                                </div>
                            </div>
                            <button 
                                id="logoutBtn"
                                class="w-full py-2 px-4 rounded-lg font-medium bg-gray-100 text-gray-700 hover:bg-gray-200"
                            >
                                Sign Out
                            </button>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="flex-1 h-full overflow-auto p-8">
                        <div class="max-w-7xl mx-auto">
                            <div id="mainContent" class="fade-in">
                                ${renderPageContent()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPageContent() {
            switch(appState.currentPage) {
                case 'dashboard':
                    return renderDashboardContent();
                case 'patients':
                    return renderPatientsPage();
                case 'doctors':
                    return renderDoctorsPage();
                case 'appointments':
                    return renderAppointmentsPage();
                case 'medical-records':
                    return renderMedicalRecordsPage();
                case 'users':
                    return renderUsersPage();
                case 'profile':
                    return renderProfilePage();
                default:
                    return renderDashboardContent();
            }
        }

        function renderDashboardContent() {
            const role = appState.currentRole;
            const username = appState.currentUser?.username || '';
            
            let greeting = `Welcome, ${username}!`;
            let roleDescription = `You are logged in as a <span class="font-semibold capitalize">${role}</span>`;
            
            if (role === 'patient') {
                greeting = `Welcome back, ${username}!`;
                roleDescription = `You are a <span class="font-semibold text-green-600">Patient</span> - You can view your medical information and available doctors`;
            }
            
            return `
                <div>
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">${greeting}</h1>
                        <p class="text-gray-600">${roleDescription}</p>
                    </div>
                    
                    <!-- Role Information Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Your Permissions</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 rounded-lg ${canCreate() ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="text-2xl font-bold ${canCreate() ? 'text-green-600' : 'text-gray-400'}">C</div>
                                <div class="text-sm font-medium ${canCreate() ? 'text-green-700' : 'text-gray-500'}">Create</div>
                                <div class="text-xs ${canCreate() ? 'text-green-600' : 'text-gray-400'}">${canCreate() ? 'Allowed' : 'Not Allowed'}</div>
                            </div>
                            <div class="text-center p-4 rounded-lg bg-green-50 border border-green-200">
                                <div class="text-2xl font-bold text-green-600">R</div>
                                <div class="text-sm font-medium text-green-700">Read</div>
                                <div class="text-xs text-green-600">Allowed</div>
                            </div>
                            <div class="text-center p-4 rounded-lg ${canEdit() ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="text-2xl font-bold ${canEdit() ? 'text-green-600' : 'text-gray-400'}">U</div>
                                <div class="text-sm font-medium ${canEdit() ? 'text-green-700' : 'text-gray-500'}">Update</div>
                                <div class="text-xs ${canEdit() ? 'text-green-600' : 'text-gray-400'}">${canEdit() ? 'Allowed' : 'Not Allowed'}</div>
                            </div>
                            <div class="text-center p-4 rounded-lg ${canDelete() ? 'bg-green-50 border border-green-200' : 'bg-gray-50 border border-gray-200'}">
                                <div class="text-2xl font-bold ${canDelete() ? 'text-green-600' : 'text-gray-400'}">D</div>
                                <div class="text-sm font-medium ${canDelete() ? 'text-green-700' : 'text-gray-500'}">Delete</div>
                                <div class="text-xs ${canDelete() ? 'text-green-600' : 'text-gray-400'}">${canDelete() ? 'Allowed' : 'Not Allowed'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-lg bg-green-50 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                    </svg>
                                </div>
                                <span class="text-2xl font-bold text-gray-900">${appState.data.patients.length}</span>
                            </div>
                            <h3 class="font-semibold text-gray-900 mb-1">Total Patients</h3>
                            <p class="text-sm text-gray-600">${role === 'patient' ? 'Your medical information' : 'Active patient records'}</p>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-lg bg-blue-50 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                </div>
                                <span class="text-2xl font-bold text-gray-900">${appState.data.doctors.length}</span>
                            </div>
                            <h3 class="font-semibold text-gray-900 mb-1">Available Doctors</h3>
                            <p class="text-sm text-gray-600">${role === 'patient' ? 'Doctors available for consultation' : 'Medical staff in the system'}</p>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 rounded-lg bg-purple-50 flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <span class="text-2xl font-bold text-gray-900">${appState.data.appointments.length}</span>
                            </div>
                            <h3 class="font-semibold text-gray-900 mb-1">Appointments</h3>
                            <p class="text-sm text-gray-600">${role === 'patient' ? 'Your scheduled appointments' : 'Total scheduled appointments'}</p>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    ${canCreate() ? `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Quick Actions</h2>
                        <div class="flex flex-wrap gap-3">
                            ${appState.currentRole === 'doctor' || appState.currentRole === 'admin' ? `
                            <button 
                                onclick="showModal('addPatientModal')"
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                                </svg>
                                Add New Patient
                            </button>
                            ` : ''}
                            
                            ${appState.currentRole === 'doctor' || appState.currentRole === 'admin' ? `
                            <button 
                                onclick="showModal('addAppointmentModal')"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                Schedule Appointment
                            </button>
                            ` : ''}
                            
                            ${appState.currentRole === 'admin' ? `
                            <button 
                                onclick="showModal('addDoctorModal')"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Add Doctor
                            </button>
                            ` : ''}
                            
                            ${appState.currentRole === 'admin' ? `
                            <button 
                                onclick="navigateTo('users')"
                                class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                </svg>
                                Manage Users
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderPatientsPage() {
            const patients = appState.data.patients;
            const role = appState.currentRole;
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Patients</h1>
                            <p class="text-gray-600">
                                ${role === 'patient' ? 'Your medical information' : 'Manage patient records'}
                            </p>
                        </div>
                        ${canCreate() ? `
                        <button 
                            onclick="showModal('addPatientModal')"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add Patient
                        </button>
                        ` : ''}
                    </div>
                    
                    ${patients.length === 0 ? `
                    <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No patients found</h3>
                        <p class="text-gray-600 mb-4">${role === 'patient' ? 'Your patient record is being prepared' : 'Add your first patient to get started'}</p>
                        ${canCreate() ? `
                        <button 
                            onclick="showModal('addPatientModal')"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                        >
                            Add Patient
                        </button>
                        ` : ''}
                    </div>
                    ` : `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Condition</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                    ${canEdit() || canDelete() ? `
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    ` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${patients.map(patient => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${patient.id || 'P001'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${patient.name || 'Unknown'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${patient.age || 'N/A'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${patient.gender === 'Male' ? 'bg-blue-100 text-blue-800' : patient.gender === 'Female' ? 'bg-pink-100 text-pink-800' : 'bg-gray-100 text-gray-800'}">
                                            ${patient.gender || 'N/A'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${patient.condition || 'N/A'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${patient.doctor || 'Unassigned'}</div>
                                    </td>
                                    ${canEdit() || canDelete() ? `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        ${canEdit() ? `
                                        <button 
                                            data-patient-id="${patient.id || ''}"
                                            data-patient-name="${patient.name || ''}"
                                            data-patient-age="${patient.age || ''}"
                                            data-patient-gender="${patient.gender || ''}"
                                            data-patient-condition="${patient.condition || ''}"
                                            data-patient-doctor="${patient.doctor || ''}"
                                            class="edit-patient-btn text-blue-600 hover:text-blue-900 mr-3"
                                        >
                                            Edit
                                        </button>
                                        ` : ''}
                                        ${canDelete() ? `
                                        <button 
                                            onclick="deletePatientPrompt('${patient.id || ''}', '${patient.name || ''}')"
                                            class="text-red-600 hover:text-red-900"
                                        >
                                            Delete
                                        </button>
                                        ` : ''}
                                    </td>
                                    ` : ''}
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `}
                </div>
            `;
        }

        function renderDoctorsPage() {
            const doctors = appState.data.doctors;
            const role = appState.currentRole;
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Doctors</h1>
                            <p class="text-gray-600">
                                ${role === 'patient' ? 'Available medical professionals for consultation' : 'Medical staff directory'}
                            </p>
                        </div>
                        ${appState.currentRole === 'admin' ? `
                        <button 
                            onclick="showModal('addDoctorModal')"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add Doctor
                        </button>
                        ` : ''}
                    </div>
                    
                    ${doctors.length === 0 ? `
                    <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No doctors found</h3>
                        <p class="text-gray-600">${role === 'admin' ? 'Add doctors to the system' : 'No doctors are currently available'}</p>
                    </div>
                    ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${doctors.map(doctor => `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-4 mb-4">
                                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center">
                                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg text-gray-900">${doctor.name || 'Dr. Unknown'}</h3>
                                    <p class="text-blue-600 font-medium">${doctor.specialty || 'General Physician'}</p>
                                    <p class="text-sm text-gray-600 mt-1">ID: ${doctor.id || 'D001'}</p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    ${doctor.email || 'email@hospital.com'}
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    ${doctor.phone || 'N/A'}
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    ${doctor.department || 'General Medicine'}
                                </div>
                            </div>
                            ${appState.currentRole === 'patient' ? `
                            <button 
                                onclick="scheduleWithDoctor('${doctor.id || ''}')"
                                class="w-full mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm"
                            >
                                Schedule Appointment
                            </button>
                            ` : ''}
                        </div>
                        `).join('')}
                    </div>
                    `}
                </div>
            `;
        }

        function renderAppointmentsPage() {
            const appointments = appState.data.appointments;
            const role = appState.currentRole;
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Appointments</h1>
                            <p class="text-gray-600">
                                ${role === 'patient' ? 'Your scheduled appointments' : 'Manage all appointments'}
                            </p>
                        </div>
                        ${canCreate() ? `
                        <button 
                            onclick="showModal('addAppointmentModal')"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Schedule Appointment
                        </button>
                        ` : ''}
                    </div>
                    
                    ${appointments.length === 0 ? `
                    <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No appointments found</h3>
                        <p class="text-gray-600 mb-4">${role === 'patient' ? 'You have no scheduled appointments' : 'Schedule appointments to get started'}</p>
                        ${canCreate() ? `
                        <button 
                            onclick="showModal('addAppointmentModal')"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600"
                        >
                            Schedule Appointment
                        </button>
                                               ` : ''}
                    </div>
                    ` : `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    ${canEdit() || canDelete() ? `
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    ` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${appointments.map(appointment => {
                                    const appointmentDate = new Date(appointment.datetime || appointment.date);
                                    const now = new Date();
                                    const isPast = appointmentDate < now;
                                    
                                    return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${appointment.id || 'A001'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${appointment.patient_name || appointment.patient_id || 'Unknown'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">${appointment.doctor_name || appointment.doctor_id || 'Unknown'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${appointmentDate.toLocaleString()}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${appointment.reason || 'N/A'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isPast ? 'bg-gray-100 text-gray-800' : 'bg-green-100 text-green-800'}">
                                            ${isPast ? 'Completed' : 'Scheduled'}
                                        </span>
                                    </td>
                                    ${canEdit() || canDelete() ? `
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        ${canEdit() ? `
                                        <button 
                                            data-appointment-id="${appointment.id || ''}"
                                            data-appointment-patient="${appointment.patient_id || ''}"
                                            data-appointment-doctor="${appointment.doctor_id || ''}"
                                            data-appointment-datetime="${appointment.datetime || ''}"
                                            data-appointment-reason="${appointment.reason || ''}"
                                            class="edit-appointment-btn text-blue-600 hover:text-blue-900 mr-3"
                                        >
                                            Reschedule
                                        </button>
                                        ` : ''}
                                        ${canDelete() ? `
                                        <button 
                                            onclick="deleteAppointmentPrompt('${appointment.id || ''}', '${appointmentDate.toLocaleDateString()}')"
                                            class="text-red-600 hover:text-red-900"
                                        >
                                            Cancel
                                        </button>
                                        ` : ''}
                                    </td>
                                    ` : ''}
                                </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                    `}
                </div>
            `;
        }

        function renderMedicalRecordsPage() {
            const records = appState.data.medicalRecords;
            const role = appState.currentRole;
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Medical Records</h1>
                            <p class="text-gray-600">
                                ${role === 'doctor' ? 'Patient medical records - view and update' : 'Medical records management'}
                            </p>
                        </div>
                        ${role === 'doctor' ? `
                        <button 
                            onclick="showAddRecordModal()"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add Record
                        </button>
                        ` : ''}
                    </div>
                    
                    ${records.length === 0 ? `
                    <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No medical records found</h3>
                        <p class="text-gray-600">${role === 'doctor' ? 'Add medical records for patients' : 'No records available'}</p>
                    </div>
                    ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${records.map(record => `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="font-bold text-lg text-gray-900">${record.patient_name || 'Unknown Patient'}</h3>
                                    <p class="text-sm text-gray-600">Record ID: ${record.id || 'R001'}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${record.type === 'consultation' ? 'bg-blue-100 text-blue-800' : record.type === 'lab_test' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${record.type ? record.type.replace('_', ' ').toUpperCase() : 'GENERAL'}
                                </span>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Diagnosis</p>
                                    <p class="font-medium text-gray-900">${record.diagnosis || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Treatment</p>
                                    <p class="font-medium text-gray-900">${record.treatment || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Date</p>
                                    <p class="font-medium text-gray-900">${record.date ? new Date(record.date).toLocaleDateString() : 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600 mb-1">Doctor</p>
                                    <p class="font-medium text-gray-900">${record.doctor_name || 'Unknown'}</p>
                                </div>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                    `}
                </div>
            `;
        }

        function renderUsersPage() {
            const users = appState.data.users || [];
            const currentRole = appState.currentRole;
            
            // Only admin can access this page
            if (currentRole !== 'admin') {
                return `
                    <div class="fade-in">
                        <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                            <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0h2m6 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Access Denied</h3>
                            <p class="text-gray-600 mb-4">This section is restricted to administrators only.</p>
                            <button onclick="navigateTo('dashboard')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                Return to Dashboard
                            </button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">User Management</h1>
                            <p class="text-gray-600">Manage system users, roles, and permissions</p>
                        </div>
                        <button 
                            onclick="openAddUserModal()"
                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add User
                        </button>
                    </div>
                    
                    ${users.length === 0 ? `
                    <div class="bg-white p-12 rounded-xl shadow-sm border border-gray-200 text-center">
                        <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No users found</h3>
                        <p class="text-gray-600 mb-4">Add users to manage the system</p>
                        <button onclick="openAddUserModal()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            Add User
                        </button>
                    </div>
                    ` : `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${users.map(user => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-8 h-8 rounded-full ${getRoleColor(user.role)} flex items-center justify-center mr-3">
                                                <span class="text-white text-xs font-semibold">
                                                    ${user.username?.charAt(0).toUpperCase() || 'U'}
                                                </span>
                                            </div>
                                            <div class="text-sm font-medium text-gray-900">${user.username || 'N/A'}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${user.firstName || ''} ${user.lastName || ''}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">${user.email || 'N/A'}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeClass(user.role)}">
                                            ${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'Unknown'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${user.status === 'active' ? 'Active' : 'Inactive'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button 
                                            onclick="editUser('${user.id || ''}')"
                                            class="text-blue-600 hover:text-blue-900 mr-3"
                                        >
                                            Edit
                                        </button>
                                        <button 
                                            onclick="deleteUserPrompt('${user.id || ''}', '${user.username || ''}')"
                                            class="text-red-600 hover:text-red-900"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    `}
                </div>
            `;
        }

        function renderProfilePage() {
            const user = appState.currentUser || {};
            const profile = appState.currentUserProfile || {};
            
            return `
                <div class="fade-in">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">My Profile</h1>
                        <p class="text-gray-600">Manage your account and personal information</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Profile Card -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-xl font-bold text-gray-900">Personal Information</h2>
                                    <button 
                                        onclick="showEditProfileModal()"
                                        class="px-4 py-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2"
                                    >
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Edit Profile
                                    </button>
                                </div>
                                
                                <div id="profileInfo" class="text-gray-700">
                                    <!-- Profile info will be loaded via loadProfileData() -->
                                    <div class="text-center py-8">
                                        <div class="animate-pulse">
                                            <div class="h-4 bg-gray-200 rounded mb-4 w-3/4 mx-auto"></div>
                                            <div class="h-4 bg-gray-200 rounded mb-4 w-1/2 mx-auto"></div>
                                            <div class="h-4 bg-gray-200 rounded mb-4 w-2/3 mx-auto"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Account Security -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-6">Account Security</h2>
                                
                                <form id="changePasswordForm" class="space-y-4" onsubmit="handlePasswordChange(event)">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                        <input type="password" id="currentPassword" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                        <input type="password" id="newPassword" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                        <input type="password" id="confirmPassword" required 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" 
                                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                            Change Password
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Account Summary -->
                        <div>
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-6">Account Summary</h2>
                                
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-sm text-gray-600">Account Created</p>
                                        <p id="accountCreated" class="font-medium">Loading...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Email Verified</p>
                                        <p id="emailVerified" class="font-medium">Loading...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Account Status</p>
                                        <p id="accountStatus" class="font-medium">Loading...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">User Role</p>
                                        <p class="font-medium capitalize">${appState.currentRole || 'Loading...'}</p>
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-6 border-t border-gray-200">
                                    <div class="text-center">
                                        <div class="w-20 h-20 mx-auto mb-4 rounded-full ${getRoleColor(appState.currentRole)} flex items-center justify-center">
                                            <span class="text-white text-2xl font-semibold">
                                                ${user.username?.charAt(0).toUpperCase() || 'U'}
                                            </span>
                                        </div>
                                        <h3 class="font-bold text-lg text-gray-900">${user.username || 'User'}</h3>
                                        <p class="text-gray-600">${user.email || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Session Info -->
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Current Session</h2>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-sm text-gray-600">Login Time</p>
                                        <p class="font-medium">${new Date().toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">IP Address</p>
                                        <p class="font-medium">127.0.0.1</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Device</p>
                                        <p class="font-medium">${navigator.userAgent.substring(0, 30)}...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return 'bg-red-500';
                case 'doctor': return 'bg-blue-500';
                case 'patient': return 'bg-green-500';
                default: return 'bg-gray-500';
            }
        }

        function getRoleBadgeClass(role) {
            switch(role) {
                case 'admin': return 'bg-red-100 text-red-800';
                case 'doctor': return 'bg-blue-100 text-blue-800';
                case 'patient': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // ==================== EVENT HANDLERS ====================
        function attachEventHandlers() {
            // Navigation buttons
            document.querySelectorAll('[data-page]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    navigateTo(page);
                });
            });
            
            // Keycloak login button
            const keycloakBtn = document.getElementById('keycloakLoginBtn');
            if (keycloakBtn) {
                keycloakBtn.addEventListener('click', redirectToKeycloak);
            }
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
            
            // Modal close buttons
            document.querySelectorAll('.close-modal-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalId = e.currentTarget.dataset.modal;
                    closeModal(modalId);
                });
            });
            
            // Patient form submission
            const patientForm = document.getElementById('addPatientForm');
            if (patientForm) {
                patientForm.addEventListener('submit', handlePatientSubmit);
            }
            
            // Appointment form submission
            const appointmentForm = document.getElementById('addAppointmentForm');
            if (appointmentForm) {
                appointmentForm.addEventListener('submit', handleAppointmentSubmit);
            }
            
            // Doctor form submission
            const doctorForm = document.getElementById('addDoctorForm');
            if (doctorForm) {
                doctorForm.addEventListener('submit', handleDoctorSubmit);
            }
            
            // User form submission
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', handleUserSubmit);
            }
            
            // Edit patient buttons
            document.querySelectorAll('.edit-patient-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const patientData = {
                        id: e.currentTarget.dataset.patientId,
                        name: e.currentTarget.dataset.patientName,
                        age: e.currentTarget.dataset.patientAge,
                        gender: e.currentTarget.dataset.patientGender,
                        condition: e.currentTarget.dataset.patientCondition,
                        doctor: e.currentTarget.dataset.patientDoctor
                    };
                    openEditPatientModal(patientData);
                });
            });
            
            // Edit appointment buttons
            document.querySelectorAll('.edit-appointment-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const appointmentData = {
                        id: e.currentTarget.dataset.appointmentId,
                        patient_id: e.currentTarget.dataset.appointmentPatient,
                        doctor_id: e.currentTarget.dataset.appointmentDoctor,
                        datetime: e.currentTarget.dataset.appointmentDatetime,
                        reason: e.currentTarget.dataset.appointmentReason
                    };
                    openEditAppointmentModal(appointmentData);
                });
            });
            
            // Load profile data if on profile page
            if (appState.currentPage === 'profile' && appState.currentUser) {
                loadProfileData();
            }
        }

        // ==================== NAVIGATION ====================
        function navigateTo(page) {
            appState.currentPage = page;
            render();
        }

        // ==================== PATIENT MANAGEMENT ====================
        async function handlePatientSubmit(e) {
            e.preventDefault();
            
            const patientData = {
                name: document.getElementById('patientName').value,
                age: document.getElementById('patientAge').value,
                gender: document.getElementById('patientGender').value,
                condition: document.getElementById('patientCondition').value,
                doctor: document.getElementById('patientDoctor').value
            };
            
            const patientId = document.getElementById('patientId').value;
            
            if (patientId) {
                // Update existing patient
                const success = await updatePatient(patientId, patientData);
                if (success) {
                    closeModal('addPatientModal');
                    resetPatientForm();
                }
            } else {
                // Create new patient
                const result = await createPatient(patientData);
                if (result.success) {
                    closeModal('addPatientModal');
                    resetPatientForm();
                }
            }
        }

        function openEditPatientModal(patientData) {
            document.getElementById('patientModalTitle').textContent = 'Edit Patient';
            document.getElementById('patientId').value = patientData.id;
            document.getElementById('patientName').value = patientData.name;
            document.getElementById('patientAge').value = patientData.age;
            document.getElementById('patientGender').value = patientData.gender;
            document.getElementById('patientCondition').value = patientData.condition;
            document.getElementById('patientDoctor').value = patientData.doctor;
            document.getElementById('patientSubmitBtn').textContent = 'Update Patient';
            
            showModal('addPatientModal');
        }

        function resetPatientForm() {
            document.getElementById('patientModalTitle').textContent = 'Add New Patient';
            document.getElementById('addPatientForm').reset();
            document.getElementById('patientId').value = '';
            document.getElementById('patientSubmitBtn').textContent = 'Add Patient';
        }

        async function deletePatientPrompt(patientId, patientName) {
            if (confirm(`Are you sure you want to delete patient "${patientName}"?`)) {
                const success = await deletePatient(patientId);
                if (success) {
                    await fetchPatients();
                    render();
                }
            }
        }

        // ==================== APPOINTMENT MANAGEMENT ====================
        async function handleAppointmentSubmit(e) {
            e.preventDefault();
            
            const appointmentData = {
                patient_id: document.getElementById('appointmentPatientId').value,
                doctor_id: document.getElementById('appointmentDoctorId').value,
                datetime: document.getElementById('appointmentDateTime').value,
                reason: document.getElementById('appointmentReason').value
            };
            
            const appointmentId = document.getElementById('appointmentId').value;
            
            if (appointmentId) {
                // Update existing appointment
                const success = await updateAppointment(appointmentId, appointmentData);
                if (success) {
                    closeModal('addAppointmentModal');
                    resetAppointmentForm();
                }
            } else {
                // Create new appointment
                const result = await createAppointment(appointmentData);
                if (result.success) {
                    closeModal('addAppointmentModal');
                    resetAppointmentForm();
                }
            }
        }

        function openEditAppointmentModal(appointmentData) {
            document.getElementById('appointmentModalTitle').textContent = 'Reschedule Appointment';
            document.getElementById('appointmentId').value = appointmentData.id;
            document.getElementById('appointmentPatientId').value = appointmentData.patient_id;
            document.getElementById('appointmentDoctorId').value = appointmentData.doctor_id;
            
            // Format datetime for input
            let datetime = appointmentData.datetime;
            if (datetime) {
                const date = new Date(datetime);
                const timezoneOffset = date.getTimezoneOffset() * 60000;
                const localDate = new Date(date.getTime() - timezoneOffset);
                datetime = localDate.toISOString().slice(0, 16);
            }
            
            document.getElementById('appointmentDateTime').value = datetime;
            document.getElementById('appointmentReason').value = appointmentData.reason;
            document.getElementById('appointmentSubmitBtn').textContent = 'Update Appointment';
            
            showModal('addAppointmentModal');
        }

        function resetAppointmentForm() {
            document.getElementById('appointmentModalTitle').textContent = 'Schedule Appointment';
            document.getElementById('addAppointmentForm').reset();
            document.getElementById('appointmentId').value = '';
            document.getElementById('appointmentSubmitBtn').textContent = 'Schedule';
        }

        async function deleteAppointmentPrompt(appointmentId, appointmentDate) {
            if (confirm(`Are you sure you want to cancel the appointment on ${appointmentDate}?`)) {
                const success = await deleteAppointment(appointmentId);
                if (success) {
                    await fetchAppointments();
                    render();
                }
            }
        }

        // ==================== DOCTOR MANAGEMENT ====================
        async function handleDoctorSubmit(e) {
            e.preventDefault();
            
            const doctorData = {
                name: document.getElementById('doctorName').value,
                specialty: document.getElementById('doctorSpecialty').value,
                email: document.getElementById('doctorEmail').value,
                phone: document.getElementById('doctorPhone').value,
                department: document.getElementById('doctorDepartment').value,
                experience: document.getElementById('doctorExperience').value
            };
            
            const result = await createDoctor(doctorData);
            if (result.success) {
                closeModal('addDoctorModal');
                document.getElementById('addDoctorForm').reset();
            }
        }

        function scheduleWithDoctor(doctorId) {
            document.getElementById('appointmentDoctorId').value = doctorId;
            showModal('addAppointmentModal');
        }

        // ==================== USER MANAGEMENT ====================
        function openAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userMode').value = 'add';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            
            showModal('userModal');
        }

        function editUser(userId) {
            const user = appState.data.users.find(u => u.id === userId);
            if (!user) {
                showError('User not found');
                return;
            }
            
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userMode').value = 'edit';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userFirstName').value = user.firstName || '';
            document.getElementById('userLastName').value = user.lastName || '';
            document.getElementById('userRole').value = user.role || 'patient';
            document.getElementById('userStatus').value = user.status || 'active';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            
            showModal('userModal');
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const userData = {
                username: document.getElementById('userUsername').value,
                email: document.getElementById('userEmail').value,
                firstName: document.getElementById('userFirstName').value,
                lastName: document.getElementById('userLastName').value,
                role: document.getElementById('userRole').value,
                status: document.getElementById('userStatus').value
            };
            
            const userId = document.getElementById('userId').value;
            const mode = document.getElementById('userMode').value;
            
            if (mode === 'add') {
                userData.password = document.getElementById('userPassword').value;
                const result = await createUser(userData);
                if (result.success) {
                    closeModal('userModal');
                }
            } else {
                const success = await updateUser(userId, userData);
                if (success) {
                    closeModal('userModal');
                }
            }
        }

        async function deleteUserPrompt(userId, username) {
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                const success = await deleteUserAPI(userId);
                if (success) {
                    await fetchUsers();
                    render();
                }
            }
        }

        // ==================== MEDICAL RECORDS ====================
        function showAddRecordModal() {
            // Create a modal for adding medical records
            const modalHTML = `
                <div id="addRecordModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Add Medical Record</h3>
                            <button class="close-modal-btn text-gray-500 hover:text-gray-700" onclick="closeModal('addRecordModal')">
                                ‚úï
                            </button>
                        </div>
                        <form id="addRecordForm" onsubmit="handleAddRecord(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                                    <input type="text" id="recordPatientId" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Diagnosis</label>
                                    <input type="text" id="recordDiagnosis" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Treatment</label>
                                    <textarea id="recordTreatment" required 
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Record Type</label>
                                    <select id="recordType" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="consultation">Consultation</option>
                                        <option value="lab_test">Lab Test</option>
                                        <option value="prescription">Prescription</option>
                                        <option value="surgery">Surgery</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3 mt-6">
                                <button type="button" onclick="closeModal('addRecordModal')" 
                                        class="px-4 py-2 border border-gray-300 rounded-md">
                                    Cancel
                                </button>
                                <button type="submit" 
                                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                                    Add Record
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
        }

        async function handleAddRecord(e) {
            e.preventDefault();
            
            const recordData = {
                patient_id: document.getElementById('recordPatientId').value,
                diagnosis: document.getElementById('recordDiagnosis').value,
                treatment: document.getElementById('recordTreatment').value,
                type: document.getElementById('recordType').value,
                date: new Date().toISOString()
            };
            
            const result = await createMedicalRecord(recordData);
            if (result.success) {
                closeModal('addRecordModal');
                const modal = document.getElementById('addRecordModal');
                if (modal) modal.remove();
                render();
            }
        }

        // ==================== INITIALIZATION ====================
        window.addEventListener('load', init);
        
        // Expose functions to global scope for inline event handlers
        window.navigateTo = navigateTo;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.deletePatientPrompt = deletePatientPrompt;
        window.deleteAppointmentPrompt = deleteAppointmentPrompt;
        window.deleteUserPrompt = deleteUserPrompt;
        window.editUser = editUser;
        window.openAddUserModal = openAddUserModal;
        window.scheduleWithDoctor = scheduleWithDoctor;
        window.showEditProfileModal = showEditProfileModal;
        window.closeEditProfileModal = closeEditProfileModal;
        window.handlePasswordChange = handlePasswordChange;
        window.handleEditProfileSubmit = handleEditProfileSubmit;
    </script>
</body>
</html>