       // ==================== EVENT HANDLERS ====================

        function attachEventHandlers() {
            // Login button
            const loginBtn = document.getElementById('keycloakLoginBtn');
            if (loginBtn) {
                loginBtn.onclick = redirectToKeycloak;
            }
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.onclick = logout;
            }
            
            // Sidebar navigation
            const pageButtons = document.querySelectorAll('[data-page]');
            pageButtons.forEach(button => {
                button.onclick = (e) => {
                    const page = e.currentTarget.dataset.page;
                    navigateTo(page);
                };
            });
            
            // Form submissions
            const addPatientForm = document.getElementById('addPatientForm');
            if (addPatientForm) {
                addPatientForm.onsubmit = handleAddPatient;
            }
            
            const addAppointmentForm = document.getElementById('addAppointmentForm');
            if (addAppointmentForm) {
                addAppointmentForm.onsubmit = handleAddAppointment;
            }

            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.onsubmit = handleUserSubmit;
            }
            
            // Close modals when clicking outside
            window.onclick = (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            };
        }

        function navigateTo(page) {
            appState.currentPage = page;
            render();
        }
        
        
        // ==================== FORM HANDLERS ====================

        async function handleAddPatient(e) {
            e.preventDefault();
            
            const patientData = {
                name: document.getElementById('patientName').value,
                age: parseInt(document.getElementById('patientAge').value),
                gender: document.getElementById('patientGender').value,
                condition: document.getElementById('patientCondition').value,
                doctor: document.getElementById('patientDoctor').value || 'Unassigned'
            };
            
            const success = await createPatient(patientData);
            if (success) {
                closeModal('addPatientModal');
                showSuccess('Patient added successfully');
                // Reset form
                e.target.reset();
            }
        }

        async function handleAddAppointment(e) {
            e.preventDefault();
            
            const appointmentDateValue = document.getElementById('appointmentDateTime').value;
            const appointmentDateIso = appointmentDateValue ? new Date(appointmentDateValue).toISOString() : null;

            const appointmentData = {
                patient_id: document.getElementById('appointmentPatientId').value,
                doctor_id: document.getElementById('appointmentDoctorId').value,
                appointment_date: appointmentDateIso,
                reason: document.getElementById('appointmentReason').value || 'General consultation',
                status: 'scheduled'
            };

            if (!appointmentData.appointment_date || appointmentData.appointment_date === 'Invalid Date') {
                showError('Please select a valid appointment date & time');
                return;
            }
            
            const success = await createAppointment(appointmentData);
            if (success) {
                closeModal('addAppointmentModal');
                showSuccess('Appointment scheduled successfully');
                // Reset form
                e.target.reset();
            }
        }

        function openUserModal(mode, user) {
            const title = document.getElementById('userModalTitle');
            const modeInput = document.getElementById('userMode');
            const idInput = document.getElementById('userId');
            const usernameInput = document.getElementById('userUsername');
            const emailInput = document.getElementById('userEmail');
            const roleInput = document.getElementById('userRole');
            const statusInput = document.getElementById('userStatus');
            const passwordRow = document.getElementById('userPasswordRow');
            const passwordInput = document.getElementById('userPassword');
            const submitBtn = document.getElementById('userSubmitBtn');

            modeInput.value = mode;

            if (mode === 'edit' && user) {
                title.textContent = 'Edit User';
                submitBtn.textContent = 'Update';
                idInput.value = user.id;
                usernameInput.value = user.username || '';
                emailInput.value = user.email || '';
                roleInput.value = user.role || 'patient';
                statusInput.value = user.status || 'active';
                passwordRow.style.display = 'none';
                passwordInput.value = '';
            } else {
                title.textContent = 'Add User';
                submitBtn.textContent = 'Create';
                idInput.value = '';
                usernameInput.value = '';
                emailInput.value = '';
                roleInput.value = 'patient';
                statusInput.value = 'active';
                passwordRow.style.display = 'block';
                passwordInput.value = '';
            }

            showModal('userModal');
        }

        function generateUserId() {
            seedUsersIfEmpty();
            const maxNum = appState.data.users
                .map(u => parseInt(String(u.id || '').replace('U', ''), 10))
                .filter(n => !Number.isNaN(n))
                .reduce((a, b) => Math.max(a, b), 0);
            const next = maxNum + 1;
            return 'U' + String(next).padStart(3, '0');
        }

        async function handleUserSubmit(e) {
            e.preventDefault();

            seedUsersIfEmpty();
            const mode = document.getElementById('userMode').value;
            const userId = document.getElementById('userId').value;
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            const password = document.getElementById('userPassword').value;

            if (mode === 'add' && !password) {
                showError('Password is required for new users');
                return;
            }

            if (mode === 'edit') {
                const idx = appState.data.users.findIndex(u => u.id === userId);
                if (idx === -1) {
                    showError('User not found');
                    return;
                }
                appState.data.users[idx] = {
                    ...appState.data.users[idx],
                    username,
                    email,
                    role,
                    status
                };
                showSuccess('User updated successfully');
            } else {
                const newId = generateUserId();
                appState.data.users.unshift({
                    id: newId,
                    username,
                    email,
                    role,
                    status
                });
                showSuccess('User created successfully');
            }

            closeModal('userModal');
            e.target.reset();
            render();
        }

        // ==================== HELPER FUNCTIONS ====================

        function editPatient(patientId) {
            // Find the patient
            const patient = appState.data.patients.find(p => p.id === patientId);
            if (!patient) {
                showError('Patient not found');
                return;
            }
            
            // In a real app, you would open an edit modal
            alert(`Edit patient: ${patient.name}\nThis would open an edit form in a real implementation.`);
        }

        function deletePatientPrompt(patientId, patientName) {
            if (confirm(`Are you sure you want to delete patient "${patientName}"?`)) {
                deletePatient(patientId).then(success => {
                    if (success) {
                        showSuccess('Patient deleted successfully');
                    }
                });
            }
        }

        function scheduleWithDoctor(doctorId) {
            // Find the doctor
            const doctor = appState.data.doctors.find(d => d.id === doctorId);
            if (!doctor) {
                showError('Doctor not found');
                return;
            }
            
            // Set the doctor ID in the appointment form and show modal
            document.getElementById('appointmentDoctorId').value = doctorId;
            showModal('addAppointmentModal');
        }

        function editAppointment(appointmentId) {
            // Find the appointment
            const appointment = appState.data.appointments.find(a => a.id === appointmentId);
            if (!appointment) {
                showError('Appointment not found');
                return;
            }
            
            alert(`Edit appointment with ${appointment.doctor_name}\nThis would open an edit form in a real implementation.`);
        }

        function cancelAppointment(appointmentId) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                // In a real app, you would call an API to update the appointment status
                showSuccess('Appointment cancelled successfully');
            }
        }

        function showAddDoctorModal() {
            alert('In a real implementation, this would open a modal to add a new doctor.');
        }

        function showAddUserModal() {
            openUserModal('add');
        }

        function editUser(userId) {
            seedUsersIfEmpty();
            const user = appState.data.users.find(u => u.id === userId);
            if (!user) {
                showError('User not found');
                return;
            }
            openUserModal('edit', user);
        }

        function deleteUser(userId, username) {
            if (confirm(`Are you sure you want to delete user "${username}"?`)) {
                seedUsersIfEmpty();
                appState.data.users = appState.data.users.filter(u => u.id !== userId);
                showSuccess(`User ${username} deleted successfully`);
                render();
            }
        }
